<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è¯å­¦ä¹ </title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>èƒŒå•è¯å°æ¸¸æˆ</h1>

        <div id="mode-selection" class="mode-selection">
            <h2>è¯·é€‰æ‹©æ¸¸æˆæ¨¡å¼</h2>
            <div class="mode-buttons">
                <button onclick="startGame('en-to-zh')">è‹±æ–‡çŒœä¸­æ–‡</button>
                <button onclick="startGame('zh-to-en')">ä¸­æ–‡çŒœè‹±æ–‡</button>
            </div>
        </div>

        <div id="game-interface" class="game-interface" style="display: none;">
            <div id="score-display">å¾—åˆ†: <span id="current-score">0</span> / <span id="total-attempts">0</span> (æ­£ç¡®ç‡: <span id="correctness-rate">0.00%</span>)</div>
            <p>å½“å‰æ¨¡å¼ï¼š<span id="current-mode">è‹±æ–‡çŒœä¸­æ–‡</span></p>
            <p id="question-text">åŸºç¡€å•è¯ï¼š<span id="base-word">ç‚¹å‡»ä¸‹é¢æŒ‰é’®å¼€å§‹</span></p>
            <div id="options"></div>
            <div class="example-section">
                <button id="show-example-btn" class="example-button" onclick="toggleExample()" style="display: none;">
                    ğŸ“– æ˜¾ç¤ºä¾‹å¥
                </button>
                <div id="example-sentence" class="example-sentence" style="display: none;">
                    <h3>ä¾‹å¥ï¼š</h3>
                    <p id="sentence-text"></p>
                </div>
            </div>
            <div class="control-buttons">
                <button onclick="getNewWord()">ğŸ² è·å–æ–°é¢˜ç›®</button>
                <button onclick="backToModeSelection()">â†©ï¸ è¿”å›é€‰æ‹©æ¨¡å¼</button>
                <button onclick="showWrongWordsModal()" class="wrong-words-button">ğŸ“ é”™é¢˜é›†</button>
            </div>
            <p id="result"></p>
        </div>

        <div id="wrong-words-modal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeWrongWordsModal()">&times;</span>
                <h2>æˆ‘çš„é”™é¢˜é›†</h2>
                <div id="wrong-words-list"></div>
                <div class="modal-actions">
                    <button onclick="clearWrongWords()">æ¸…ç©ºé”™é¢˜é›†</button>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ éŸ³é¢‘å…ƒç´  -->
        <audio id="wordAudio" style="display: none;"></audio>
    </div>

    <script>
        let answer = null;
        let currentGameMode = null;
        let currentBaseWord = null;
        let currentExampleSentence = null;

        const currentScoreSpan = document.getElementById('current-score');
        const totalAttemptsSpan = document.getElementById('total-attempts');
        const correctnessRateSpan = document.getElementById('correctness-rate');

        async function fetchScoreAndRate() {
            try {
                const response = await fetch('/check_answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get_score_only' })
                });
                const data = await response.json();
                updateScoreDisplay(data.score, data.total_attempts, data.correctness_rate);
            } catch (error) {
                console.error('è·å–åˆ†æ•°å¤±è´¥:', error);
            }
        }

        function updateScoreDisplay(score, attempts, rate) {
            currentScoreSpan.textContent = score;
            totalAttemptsSpan.textContent = attempts;
            correctnessRateSpan.textContent = `${rate.toFixed(2)}%`;
        }

        function startGame(mode) {
            currentGameMode = mode;
            document.getElementById('mode-selection').style.display = 'none';
            document.getElementById('game-interface').style.display = 'block';
            document.getElementById('current-mode').innerText = mode === 'en-to-zh' ? 'è‹±æ–‡çŒœä¸­æ–‡' : 'ä¸­æ–‡çŒœè‹±æ–‡';
            document.getElementById('question-text').innerHTML = mode === 'en-to-zh' ?
                'åŸºç¡€å•è¯ï¼š<span id="base-word">ç‚¹å‡»ä¸‹é¢æŒ‰é’®å¼€å§‹</span>' :
                'ä¸­æ–‡é‡Šä¹‰ï¼š<span id="base-word">ç‚¹å‡»ä¸‹é¢æŒ‰é’®å¼€å§‹</span>';
            getNewWord();
            fetchScoreAndRate();
        }

        function backToModeSelection() {
            document.getElementById('mode-selection').style.display = 'block';
            document.getElementById('game-interface').style.display = 'none';
            document.getElementById('result').innerText = '';
            document.getElementById('example-sentence').style.display = 'none';
            document.getElementById('show-example-btn').style.display = 'none';
            currentGameMode = null;
            closeWrongWordsModal();
        }

        // åˆ‡æ¢ä¾‹å¥æ˜¾ç¤º/éšè—
        function toggleExample() {
            const exampleSentence = document.getElementById('example-sentence');
            const showExampleBtn = document.getElementById('show-example-btn');
            
            if (exampleSentence.style.display === 'none') {
                exampleSentence.style.display = 'block';
                showExampleBtn.textContent = 'ğŸ“– éšè—ä¾‹å¥';
            } else {
                exampleSentence.style.display = 'none';
                showExampleBtn.textContent = 'ğŸ“– æ˜¾ç¤ºä¾‹å¥';
            }
        }

        // ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿçš„ Web Speech API
        function playWordAudio(word) {
            console.log('Attempting to play word:', word);  // è°ƒè¯•æ—¥å¿—
            if ('speechSynthesis' in window) {
                console.log('Speech synthesis is available');  // è°ƒè¯•æ—¥å¿—
                try {
                    const utterance = new SpeechSynthesisUtterance(word);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.8;  // è¯­é€Ÿç¨æ…¢
                    utterance.pitch = 1;   // éŸ³è°ƒ
                    utterance.volume = 1;  // éŸ³é‡

                    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                    utterance.onstart = () => console.log('Speech started');
                    utterance.onend = () => console.log('Speech ended');
                    utterance.onerror = (event) => console.error('Speech error:', event);

                    // è·å–å¯ç”¨çš„å£°éŸ³åˆ—è¡¨
                    let voices = speechSynthesis.getVoices();
                    // å°è¯•æ‰¾åˆ°è‹±è¯­ç”·å£°
                    let englishVoice = voices.find(voice => 
                        voice.lang.includes('en') && voice.name.includes('Male')
                    );
                    if (englishVoice) {
                        utterance.voice = englishVoice;
                    }

                    // æ’­æ”¾è¯­éŸ³
                    window.speechSynthesis.speak(utterance);
                } catch (error) {
                    console.error('Error playing audio:', error);
                }
            } else {
                console.error('Speech synthesis not supported in this browser');
            }
        }

        // ç¡®ä¿åœ¨é¡µé¢åŠ è½½æ—¶è·å–å¯ç”¨çš„å£°éŸ³åˆ—è¡¨
        window.addEventListener('load', function() {
            console.log('Page loaded, checking speech synthesis...');
            if ('speechSynthesis' in window) {
                console.log('Speech synthesis is available');
                // è·å–å£°éŸ³åˆ—è¡¨
                let voices = speechSynthesis.getVoices();
                console.log('Available voices:', voices.map(v => `${v.name} (${v.lang})`));
            } else {
                console.error('Speech synthesis not supported in this browser');
            }
        });

        // å¦‚æœå£°éŸ³åˆ—è¡¨è¿˜æ²¡æœ‰åŠ è½½å®Œæˆï¼Œç­‰å¾…å®ƒä»¬åŠ è½½
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = function() {
                console.log('Voices loaded:', speechSynthesis.getVoices().map(v => `${v.name} (${v.lang})`));
            };
        }

        // ä¿®æ”¹ getNewWord å‡½æ•°ï¼Œç¡®ä¿åœ¨æ­£ç¡®çš„æ—¶æœºè°ƒç”¨æ’­æ”¾
        function getNewWord() {
            fetch('/get_word', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ mode: currentGameMode })
            }).then(res => res.json()).then(data => {
                if (data.error) {
                    document.getElementById("base-word").innerText = `é”™è¯¯: ${data.error}`;
                    document.getElementById("options").innerHTML = "";
                    document.getElementById("result").innerText = "";
                    return;
                }
                document.getElementById("base-word").innerText = data.base_word;
                answer = data.answer;
                currentBaseWord = data.base_word;
                currentExampleSentence = data.example_sentence;
                
                const container = document.getElementById("options");
                container.innerHTML = "";
                data.options.forEach(opt => {
                    const btn = document.createElement("button");
                    btn.innerText = opt;
                    btn.classList.add('option-button');
                    btn.onclick = () => { selectAnswer(opt, answer, data.base_word); };
                    container.appendChild(btn);
                });
                document.getElementById("result").innerText = '';

                // å¤„ç†ä¾‹å¥æŒ‰é’®
                if (data.example_sentence) {
                    document.getElementById('sentence-text').innerText = data.example_sentence;
                    document.getElementById('show-example-btn').style.display = 'inline-block';
                    document.getElementById('example-sentence').style.display = 'none';
                } else {
                    document.getElementById('show-example-btn').style.display = 'none';
                    document.getElementById('example-sentence').style.display = 'none';
                }

                // ç¡®ä¿åœ¨è‹±æ–‡çŒœä¸­æ–‡æ¨¡å¼ä¸‹æ’­æ”¾
                if (currentGameMode === 'en-to-zh') {
                    console.log('Current mode is en-to-zh, playing audio for:', data.base_word);  // è°ƒè¯•æ—¥å¿—
                    setTimeout(() => playWordAudio(data.base_word), 100);  // æ·»åŠ å°å»¶è¿Ÿç¡®ä¿ DOM æ›´æ–°å®Œæˆ
                } else {
                    console.log('Current mode is not en-to-zh, skipping audio');  // è°ƒè¯•æ—¥å¿—
                }
            });
        }

        async function selectAnswer(selectedAnswer, correctAnswer, baseWord) {
            try {
                const response = await fetch('/check_answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_answer: selectedAnswer,
                        correct_option: correctAnswer,
                        base_word: baseWord
                    })
                });
                const data = await response.json();

                document.getElementById("result").innerText = (selectedAnswer === correctAnswer ? "âœ… æ­£ç¡®ï¼" : "âŒ é”™äº†ï¼");

                updateScoreDisplay(data.score, data.total_attempts, data.correctness_rate);

                getNewWord();

            } catch (error) {
                console.error('å‘é€ç­”æ¡ˆæˆ–æ ¡éªŒå¤±è´¥:', error);
                document.getElementById("result").innerText = "å‘é€ç­”æ¡ˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ§åˆ¶å°é”™è¯¯ã€‚";
            }
        }

        // æ˜¾ç¤ºé”™é¢˜é›†æ¨¡æ€æ¡†
        async function showWrongWordsModal() {
            const modal = document.getElementById('wrong-words-modal');
            const wrongWordsList = document.getElementById('wrong-words-list');
            wrongWordsList.innerHTML = 'åŠ è½½ä¸­...';

            try {
                const response = await fetch('/get_wrong_words');
                const data = await response.json();

                if (data.wrong_words && data.wrong_words.length > 0) {
                    let html = '<ul>';
                    data.wrong_words.forEach(word => {
                        html += `<li><strong>${word.base_word}</strong> &mdash; ${word.correct_answer}</li>`;
                    });
                    html += '</ul>';
                    wrongWordsList.innerHTML = html;
                } else {
                    wrongWordsList.innerHTML = '<p>æ­å–œï¼Œæ‚¨è¿˜æ²¡æœ‰é”™é¢˜ï¼</p>';
                }
            } catch (error) {
                console.error('è·å–é”™é¢˜é›†å¤±è´¥:', error);
                wrongWordsList.innerHTML = '<p>è·å–é”™é¢˜é›†å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</p>';
            }
            modal.style.display = 'flex';
        }

        function closeWrongWordsModal() {
            document.getElementById('wrong-words-modal').style.display = 'none';
        }

        // æ¸…ç©ºé”™é¢˜é›†
        async function clearWrongWords() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºé”™é¢˜é›†å—ï¼Ÿ')) {
                try {
                    const response = await fetch('/clear_wrong_words', { method: 'POST' });
                    const data = await response.json();
                    if (data.status === 'ok') {
                        alert('é”™é¢˜é›†å·²æ¸…ç©ºï¼');
                        showWrongWordsModal();
                    }
                } catch (error) {
                    console.error('æ¸…ç©ºé”™é¢˜é›†å¤±è´¥:', error);
                    alert('æ¸…ç©ºé”™é¢˜é›†å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
                }
            }
        }
    </script>

    <!-- Live2D widget -->
    <script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
</body>
</html>